#!/usr/bin/env bash

MAIL_PROP_FILE="mail.properties"
WORKBENCH="/home/automation/workbench/automation/nscore/smoke"
RESULTS_DIR="$WORKBENCH/results"
version=$(nsu_get_version | head -1 | awk -F " " '{print $2}')
build=$(nsu_get_version | head -1 | cut -d '#' -f2 | cut -d ')' -f1 | sed -e 's/\ //g')
buildtimestamp=$(date)
SMOKE_RESULT_FILES="$RESULTS_DIR/${version}/.${build}"
TMP_FAIL_CASE_FILE="/tmp/automation.log.failed"

function get_metrics(){
    file="$1"
    pattern="$2"
    count=$(grep "$pattern" ${file} | wc -l)
    echo $count
}

    
function set_test_results(){ 
    first_attachment=$(ls -tr $SMOKE_RESULT_FILES/*.txt | tail -1)
    passed=0;failed=0
    total=$(grep "TotalExecuted" /tmp/last | cut -d '=' -f2)
    nsfail=$(grep "NSFailCount" /tmp/last | cut -d '=' -f2)

    if [ $nsfail -eq 0 ] && [ $total -ne 0 ]; then
	  
	    failed=$(($failed + $(get_metrics $SMOKE_RESULT_FILES/$first_attachment ",fail,")))
	    passed=$(($passed + $(get_metrics $SMOKE_RESULT_FILES/first_attachment ",pass,")))
        nsfail=0

		if [ $total -eq $passed ] && [ $total -ne 0 ] && [ $nsfail -eq 0 ];then
			STATUS=Successful
		else
			STATUS=Failed
		fi
    else
        STATUS=Failed
        failed=$(($failed + $(get_metrics $SMOKE_RESULT_FILES/$first_attachment ",fail,")))
        passed=$(($passed + $(get_metrics $SMOKE_RESULT_FILES/$first_attachment ",pass,")))
    fi
}


function get_fail_test_data() {
    if [ $failed -gt 0 ]; then
	str=""
	R_FILE=$(ls -tr $SMOKE_RESULT_FILES/*.txt | tail -1)
       
	grep ',fail,' $R_FILE >"$TMP_FAIL_CASE_FILE"
     
	while read line;
	do
	    id=$(echo "$line" | cut -d, -f1) 
	    tr=$(echo "$line" | cut -d, -f2) 
	    desc=$(echo "$line" | cut -d, -f8) 
	    str+="<tr><td>$id</td><td>$tr</td><td>$desc</td></tr>"
	done <"$TMP_FAIL_CASE_FILE"
	
	caption="<caption>Failed Testcases</caption>"
	th="<tr><th>Testcase ID</th><th>Test run</th><th>Description</th></tr>" 
	table="<br><br><table>$caption $th $str</table>"
	
	echo "$table"
    else
        echo ""
    fi
}


function set_up_email(){
    set_test_results
    echo -e "
<!DOCTYPE html>
<html>
<head>
    <style type='text/css'>
       .container{
          width: 600px;
          padding: 10px;
          background-color: #FAFAFA;
          border: 1px solid #e0e0e0;
        }
        table {
            border-collapse: collapse;
            width: 80%;
        }
        table, th, td { 
            border: 1px solid #e0e0e0;
            padding: 10px;
            font-size: 1em;
        }
        th {
           background-color: #2196f3;
           color: #e3f2fd;
           text-align: left;
        }
        tr td{
           background-color: #F5F5F5;
           color: #757575;
        }
        .divider {
          border-top: 1px solid #e0e0e0;
        }
        .signature{ color: #607d8b;}
          
    </style>
</head>
<body>
    <div class='container'>
	<h5>GENERAL INFO</h5>
	Build $STATUS
	<br>
	<b>Project</b>: NSCore Smoke
	<br><b>End Time</b>: $buildtimestamp
    <br>
    <div class='divider'></div>
    <h5>Test Results</h5>
    <table>
        <tr>
            <th>Category</th>
            <th>Total</th>
            <th>Passed</th>
            <th>Failed</th>
            <th>Netstorm Fail</th>
        </tr>
        <tr>
            <td>Smoke</td>
            <td>$total</td>
            <td>$passed</td>
            <td>$failed</td>
            <td>$nsfail</td>
        </tr>
    </table>
    $(get_fail_test_data)
    <br>
    <a href='http://10.10.30.37:5000/' style='text-decoration: none; color: #263238;'>Click to see online reports</a>
    <div class='divider'></div>
   <br><br>
   <div class='signature'>
      Automation Team,<br>Cavisson Systems Inc
   </div>
</div>
</body>
</html>" >/home/automation/workbench/automation/nscore/lib/mail_results.html
    echo "curr.release = $version" >${MAIL_PROP_FILE}
    echo "curr.build = $build" >>${MAIL_PROP_FILE}
    #echo "configured.mail.list.to = dl-qa-teamleads@cavisson.com,arun.yadav@cavisson.com,neeraj@cavisson.com,functionalheads@cavisson.com" >>${MAIL_PROP_FILE}
    echo "configured.mail.list.to = niraj.panda@cavisson.com" >>${MAIL_PROP_FILE}
    #echo "configured.mail.list.cc = dl-qa-nsc@cavisson.com" >>${MAIL_PROP_FILE}
    echo "configured.mail.list.cc = vishal.singhal@cavisson.com" >>${MAIL_PROP_FILE}
    echo -e "buil.status.header = $STATUS" >>${MAIL_PROP_FILE}
    echo -e "mail.result.file = /home/automation/workbench/automation/nscore/lib/mail_results.html" >>${MAIL_PROP_FILE}
    echo -e "smoke.results.dir = $SMOKE_RESULT_FILES" >>${MAIL_PROP_FILE}
    echo -e "first.attachment = $first_attachment" >>${MAIL_PROP_FILE}
}

set_up_email
