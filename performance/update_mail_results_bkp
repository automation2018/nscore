#!/usr/bin/env bash

MAIL_PROP_FILE="mail.properties"
WORKBENCH="/home/automation/workbench/automation/nscore/performance"
RESULTS_DIR="$WORKBENCH/results"
version=$(nsu_get_version | head -1 | awk -F " " '{print $2}')
build=$(nsu_get_version | head -1 | cut -d '#' -f2 | cut -d ')' -f1 | sed -e 's/\ //g')

buildtimestamp=$(date +'%d/%m/%y %I:%M:%S %p')
start_time=${1}

PERF_RESULT_FILES="$RESULTS_DIR/${version}/.${build}"

function get_metrics(){
    file="$1"
    pattern="$2"
    count=$(grep "<testsuite " ${file} | egrep -ow "${pattern}=\"[0-9]+\""|egrep -o  "[0-9]+")
    echo $count
}

function get_pct_change() {
    baseline="$1"
    current="$2"
    echo $(python -c "print '%3.3f' %((float($current - $baseline) / $current) * 100)")
}
    
function set_test_results(){ 
    first_attachment=$(basename $(ls -tr $PERF_RESULT_FILES/*.xml | tail -1))
    second_attachment=$(basename $(ls -tr $PERF_RESULT_FILES/*.xml | tail -2 |head -1))
    total=0;passed=0;failed=0
    ATTACHMENTS=( "$first_attachment" "$second_attachment" )

    #TODO
    #Check xml file for netstorm fail cases
    #This is to ensure all tests ran;status has been checked;if some tests has been
    #due to NetStormFail;hence reports should be generated accordingly
    for attachment in ${ATTACHMENTS[*]}; do
        total=$(($total + $(get_metrics $PERF_RESULT_FILES/$attachment "total")))
        failed=$(($failed + $(get_metrics $PERF_RESULT_FILES/$attachment "failures")))
        passed=$(($passed + $(get_metrics $PERF_RESULT_FILES/$attachment "passed")))
    done 
    statusbody=$(echo "Failed: $failed test(s), Passed: $passed test(s), Total: $total test(s)")
    cps=$(grep "CPS" $WORKBENCH/.perf/PerfResult | cut -d ',' -f8)
    hps=$(grep "HPS" $WORKBENCH/.perf/PerfResult | cut -d ',' -f9)
    throughput=$(grep "THROUGHPUT" $WORKBENCH/.perf/PerfResult | cut -d ',' -f10)

    if [ $total -eq $passed ];then
        STATUS=Successful
    else
	STATUS=Failed
    fi
}

function set_up_email(){
    set_test_results
    echo -e "
<!DOCTYPE html>
<html>
<head>
    <style type='text/css'>
       .container{
          width: 600px;
          padding: 10px;
          background-color: #F5F5F5;
          border: 1px solid #A3C3FF;
        }
        table {
            border-collapse: collapse;
            width: 80%;
        }
        table, th, td { 
            border: 1px solid #A3C3FF;
            padding: 10px;
        }
        th {
           background-color: #A3C3FF;
           color: #FAFAFA;
           text-align: left;
        }
        tr td:first-child{
           background-color: #F1F1F1;
        }
        hr {
          color: #A3C3FF;
        }
    </style>
</head>
<body>
    <div class='container'>
	<h5>GENERAL INFO</h5>
	Build $STATUS
	<br>
	<b>Project</b>: NSCore Performance
	<br><b>Start Time</b>: ${start_time}
	<br><b>End Time</b>: $buildtimestamp
    <br>
    <hr/>
    <h5>Test Results</h5>
    <table>
        <tr>
            <th>Metric</th>
            <th>Baseline</th>
            <th>Current</th>
            <th>% Change</th>
        </tr>
        <tr>
            <td>Cps</td>
            <td>57115</td>
            <td>$cps</td>
            <td>$(get_pct_change 57115 $cps)</td>
        </tr>
        <tr>
            <td>Hps</td>
            <td>314745</td>
            <td>$hps</td>
            <td>$(get_pct_change 314745 $hps)</td>
        </tr>
        <tr>
            <td>Throughput</td>
            <td>962017</td>
            <td>$throughput</td>
            <td>$(get_pct_change 962017 $throughput)</td>
        </tr>
    </table>
    <h5>$statusbody</h5>
    <br>
    <a href='http://10.10.30.37:5000/'>View Online Automation Reports</a>
    <hr/>
    <br><br>
    Automation Team,
   <br>Cavisson Systems Inc
   </div>
</body>
</html>" >/home/automation/workbench/automation/nscore/lib/mail_results.html
    echo "curr.release = $version" >${MAIL_PROP_FILE}
    echo "curr.build = $build" >>${MAIL_PROP_FILE}
    echo "configured.mail.list.to = dl-qa-teamleads@cavisson.com,arun.yadav@cavisson.com,neeraj@cavisson.com,functionalheads@cavisson.com" >>${MAIL_PROP_FILE}
    echo "configured.mail.list.cc = dl-qa-nsc@cavisson.com" >>${MAIL_PROP_FILE}
    echo -e "buil.status.header = $STATUS" >>${MAIL_PROP_FILE}
    echo -e "mail.result.file = /home/automation/workbench/automation/nscore/lib/mail_results.html" >>${MAIL_PROP_FILE}
    echo -e "perf.results.dir = $PERF_RESULT_FILES" >>${MAIL_PROP_FILE}
    echo -e "first.attachment = $first_attachment" >>${MAIL_PROP_FILE}
    echo -e "second.attachment = $second_attachment" >>${MAIL_PROP_FILE}
}

set_up_email
