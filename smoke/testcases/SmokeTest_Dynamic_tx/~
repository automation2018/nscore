#!/usr/bin/env bash
# Check status written by: Asheesh Kumar Tivaree
#    Date Time: 09/09/16 10:54:38 AM
#  Description: Check status to validate cases for smoke
# 
# Conventions
#   1. Two(2) space indentation. No tabs
#   2. Variables and function starts with snake_case
#		3. Constants are declared with ALL_CAPS

# Source out required files
source $NS_WDIR/lib/automation_util

# Default Constants
PATH_TO_TEST_RUN="$NS_WDIR/logs/TR${T_RUN_ID}"
PARTITION_PATH="${PATH_TO_TEST_RUN}/$(get_test_partition)"
TRANS_DETAIL="${PATH_TO_TEST_RUN}/trans_detail.dat"
PROGRESS_REPORT_FILE="${PATH_TO_TEST_RUN}/progress.report"
DEBUG_LOG_FILE="${PATH_TO_TEST_RUN}/debug.log"
URL_REQ_FILE="${PATH_TO_TEST_RUN}/2*/ns_logs/req_rep/url_req*"
URL_REP_FILE="${PATH_TO_TEST_RUN}/2*/ns_logs/req_rep/url_rep*"
SCRIPT_FLOW_FILE="${PATH_TO_TEST_RUN}/scripts/*/flow.c"
SCRIPT_FLOW_FILE_EX="${PATH_TO_TEST_RUN}/scripts/Http2_script1/flow.c"
T_NAME="$(get_tname)"

# Entry point to check status
# Add cases to handle your validation
function main() {
	case $(get_tname) in
    "SMOKE-066-001") handle_DynTx-001 ;;
    "SMOKE-066-002") handle_DynTx-002 ;;
    "SMOKE-066-003") handle_DynTx-003 ;;
    "SMOKE-066-004") handle_DynTx-004 ;;
    "SMOKE-066-005") handle_DynTx-005 ;;
    "SMOKE-066-006") handle_DynTx-006 ;;
    "SMOKE-066-007") handle_DynTx-007 ;;
    "SMOKE-066-008") handle_DynTx-008 ;;
# End case def
		*) handle_unknown_case ;;
		?) handle_unknown_case ;;
  esac
}

# Helper function to log status
# Sets additional product id and
# category id
function handle_unknown_case() {
	error "Testcase name not found"
	log_status_and_exit_ex "FAIL" "Testcase name not found"
}

# TODO: 
# 1. Add logic to validate case smoke-001
# 2. Depending upon evaluation update the status with your own description

function get_actual_details()
{
   script_tx_count=$(grep "ns_start_transaction" $SCRIPT_FLOW_FILE | wc -l)
   total_session_completed=$(grep "Session Report" $PROGRESS_REPORT_FILE | awk -F ':' '{print $3}' | awk -F ' ' '{print $3}')
   transaction_completed=$(grep "Transaction Report" $PROGRESS_REPORT_FILE | tail -1 | awk -F ':' '{print $3}' | cut -d ' ' -f4)
   tx_report=$((transaction_completed/total_session_completed))
   trans_detail=$(cat $TRANS_DETAIL | head -$((script_tx_count+1)) | tail -$script_tx_count | wc -l)
   Url_success=$(grep "Url  Report" $PROGRESS_REPORT_FILE | cut -d '/' -f2| awk '{print $2}')
   Url_completed=$(grep "Url  Report" $PROGRESS_REPORT_FILE | cut -d ':' -f3 | cut -d '/' -f1 | awk '{print $2}')
   if [ $Url_completed -ne $Url_success ];then
      Failure_reason=$(grep "Url  Report" $PROGRESS_REPORT_FILE | cut -d '/' -f3 | cut -d ':' -f1)
   else
      Failure_reason=0
   fi
 }

function handle_DynTx-001()
{
 get_actual_details
 debug_log "case 1"
 debug_log "script tx count=$script_tx_count"
 debug_log "total_session_completed=$total_session_completed"
 debug_log "transaction_completed=$transaction_completed"
 debug_log "tx_report=$tx_report"
 debug_log "trans_detail=$trans_detail"
 debug_log "Url_success=$Url_success"
 debug_log "Url_completed=$Url_completed"
 if [ $Failure_reason -eq 0 ];then
    if [ $script_tx_count -eq $tx_report ];then
       if [ $tx_report -eq $trans_detail ];then
            log_status_and_exit_ex "PASS" "One static and multiple dynamic transactions case"
        else
          log_status_and_exit_ex "FAIL" "One static and multiple dynamic transactions case failed due to missmatch between progress report and transa_detal file"
        fi
    else
    log_status_and_exit_ex "FAIL" "One static and multiple dynamic transactions case failed due to missmatch between script tx count and transaction report"
    fi
 else
    log_status_and_exit_ex "FAIL" "One static and multiple dynamic transactions case failed due to $Failure_reason error"
fi

 }


function handle_DynTx-002() {
 get_actual_details
 debug_log "case 2"
 debug_log "script tx count=$script_tx_count"
 debug_log "total_session_completed=$total_session_completed"
 debug_log "transaction_completed=$transaction_completed"
 debug_log "tx_report=$tx_report"
 debug_log "trans_detail=$trans_detail"
 debug_log "Url_success=$Url_success"
 debug_log "Url_completed=$Url_completed"
 if [ $Failure_reason -eq 0 ];then
    if [ $script_tx_count -eq $tx_report ];then
       if [ $tx_report -eq $trans_detail ];then
            log_status_and_exit_ex "PASS" "All dynamic transactions case"
        else
          log_status_and_exit_ex "FAIL" "All dynamic transactions case failed due to missmatch between progress report and transa_detal file"
        fi
    else
    log_status_and_exit_ex "FAIL" "All dynamic transactions case failed due to missmatch between script tx count and transaction report"
    fi
 else
    log_status_and_exit_ex "FAIL" "All dynamic transactions case failed due to $Failure_reason error"
fi

}

function handle_DynTx-003() {
 get_actual_details
 debug_log "case 3"
 debug_log "script tx count=$script_tx_count"
 debug_log "total_session_completed=$total_session_completed"
 debug_log "transaction_completed=$transaction_completed"
 debug_log "tx_report=$tx_report"
 debug_log "trans_detail=$trans_detail"
 debug_log "Url_success=$Url_success"
 debug_log "Url_completed=$Url_completed"
 if [ $Failure_reason -eq 0 ];then
    if [ $script_tx_count -eq $tx_report ];then
       if [ $tx_report -eq $trans_detail ];then
            log_status_and_exit_ex "PASS" "One static using c-var and multiple dynamic transactions"
        else
          log_status_and_exit_ex "FAIL" "One static using c-var and multiple dynamic transactions case failed due to missmatch between progress report and transa_detal file"
        fi
    else
    log_status_and_exit_ex "FAIL" "One static using c-var and multiple dynamic transactions case failed due to missmatch between script tx count and transaction report"
    fi
 else
    log_status_and_exit_ex "FAIL" "One static using c-var and multiple dynamic transactions case failed due to $Failure_reason error"
fi

}

function handle_DynTx-004() {
 get_actual_details
 c_var=$(grep "c_var_tx" $TRANS_DETAIL | awk -F '|' '{print $1}')
 debug_log "case 4"
 debug_log "c-var = $c_var"
 debug_log "script tx count=$script_tx_count"
 debug_log "total_session_completed=$total_session_completed"
 debug_log "transaction_completed=$transaction_completed"
 debug_log "tx_report=$tx_report"
 debug_log "trans_detail=$trans_detail"
 debug_log "Url_success=$Url_success"
 debug_log "Url_completed=$Url_completed"
 if [ $Failure_reason -eq 0 ];then
     if [ "$c_var" == "c_var_tx" ];then
       if [ $script_tx_count -eq $tx_report ];then
          if [ $tx_report -eq $trans_detail ];then
            log_status_and_exit_ex "PASS" "One static to c-var using end_as and multiple dynamic transactions"
            else
            log_status_and_exit_ex "FAIL" "One static to c-var using end_as and multiple dynamic transactions case failed due to missmatch between progress report and transa_detal file"
          fi
      else
          log_status_and_exit_ex "FAIL" "One static to c-var using end_as and multiple dynamic transactions case failed due to missmatch between script tx count and transaction report"
      fi
    else
    log_status_and_exit_ex "FAIL" "One static to c-var using end_as and multiple dynamic transactions case failed because transaction is not ended with c-var"
    fi
 else
    log_status_and_exit_ex "FAIL" "One static to c-var using end_as and multiple dynamic transactions case failed due to $Failure_reason error"
fi
}

function handle_DynTx-005() {
 get_actual_details
 c_var=$(grep "c_var_tx" $TRANS_DETAIL | awk -F '|' '{print $1}')
 debug_log "case 5"
 debug_log "c-var = $c_var"
 debug_log "script tx count=$script_tx_count"
 debug_log "total_session_completed=$total_session_completed"
 debug_log "transaction_completed=$transaction_completed"
 debug_log "tx_report=$tx_report"
 debug_log "trans_detail=$trans_detail"
 debug_log "Url_success=$Url_success"
 debug_log "Url_completed=$Url_completed"
 if [ $Failure_reason -eq 0 ];then
     if [ "$c_var" == "c_var_tx" ];then
       if [ $script_tx_count -eq $tx_report ];then
          if [ $tx_report -eq $trans_detail ];then
            log_status_and_exit_ex "PASS" "Dynamic tx to c-var using end_as"
            else
            log_status_and_exit_ex "FAIL" "Dynamic tx to c-var using end_as case failed due to missmatch between progress report and transa_detal file"
          fi
      else
          log_status_and_exit_ex "FAIL" "Dynamic tx to c-var using end_as case failed due to missmatch between script tx count and transaction report"
      fi
    else
        log_status_and_exit_ex "FAIL" "Dynamic tx to c-var using end_as case failed because transaction is not ended with c-var"
    fi
 else
    log_status_and_exit_ex "FAIL" "Dynamic tx to c-var using end_as case failed due to $Failure_reason error"
fi
}

function handle_DynTx-006() {
 get_actual_details
 c_var=$(grep "c_var_tx" $TRANS_DETAIL | awk -F '|' '{print $1}' | wc -l)
 debug_log "case 6"
 debug_log "c-var = $c_var"
 debug_log "script tx count=$script_tx_count"
 debug_log "total_session_completed=$total_session_completed"
 debug_log "transaction_completed=$transaction_completed"
 debug_log "tx_report=$tx_report"
 debug_log "trans_detail=$trans_detail"
 debug_log "Url_success=$Url_success"
 debug_log "Url_completed=$Url_completed"
 if [ $Failure_reason -eq 0 ];then
     if [ $c_var -eq 0 ];then
       if [ $script_tx_count -eq $tx_report ];then
          if [ $tx_report -eq $trans_detail ];then
            log_status_and_exit_ex "PASS" "C-var to dynamic tx using end_as"
            else
            log_status_and_exit_ex "FAIL" "C-var to dynamic tx using end_as case failed due to missmatch between progress report and transa_detal file"
          fi
      else
          log_status_and_exit_ex "FAIL" "C-var to dynamic tx using end_as case failed due to missmatch between script tx count and transaction report"
      fi
    else
        log_status_and_exit_ex "FAIL" "C-var to dynamic tx using end_as case failed because c-var's transaction is not ended with dynamic tx"
    fi
 else
    log_status_and_exit_ex "FAIL" "C-var to dynamic tx using end_as case failed due to $Failure_reason error"
fi
}

function handle_DynTx-007() {
 get_actual_details
 c_var=$(grep "static_tx2" $TRANS_DETAIL | awk -F '|' '{print $1}' | wc -l)
 debug_log "case 7"
 debug_log "c-var = $c_var"
 debug_log "script tx count=$script_tx_count"
 debug_log "total_session_completed=$total_session_completed"
 debug_log "transaction_completed=$transaction_completed"
 debug_log "tx_report=$tx_report"
 debug_log "trans_detail=$trans_detail"
 debug_log "Url_success=$Url_success"
 debug_log "Url_completed=$Url_completed"
 if [ $Failure_reason -eq 0 ];then
     if [ $c_var -eq 0 ];then
       if [ $script_tx_count -eq $tx_report ];then
          if [ $tx_report -eq $trans_detail ];then
            log_status_and_exit_ex "PASS" "Static to dynamic tx using end_as"
            else
            log_status_and_exit_ex "FAIL" "Static to dynamic using end_as case failed due to missmatch between progress report and transa_detal file"
          fi
      else
          log_status_and_exit_ex "FAIL" "Static to dynamic using end_as case failed due to missmatch between script tx count and transaction report"
      fi
    else
        log_status_and_exit_ex "FAIL" "Static to dynamic using end_as case failed because static's transaction is not ended with dynamic tx"
    fi
 else
    log_status_and_exit_ex "FAIL" "Static to dynamic using end_as case failed due to $Failure_reason error"
fi
}

function handle_DynTx-008() {
echo "hello"

}


# Do not override it
main
exit 0
